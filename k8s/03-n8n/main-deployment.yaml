# n8n Main Server Deployment
# Handles the web UI and workflow editing
#
# NOTE: Environment variables are duplicated between this deployment and worker-deployment.yaml
# This is intentional to keep manifests self-contained and avoid templating complexity.
# Both deployments need the same database and queue configuration to function properly.
apiVersion: apps/v1
kind: Deployment
metadata:
  name: n8n-main
  namespace: n8n
spec:
  replicas: 1
  selector:
    matchLabels:
      app: n8n-main
  template:
    metadata:
      labels:
        app: n8n-main
    spec:
      serviceAccountName: n8n-secrets-sa
      containers:
      - name: n8n
        image: n8nio/n8n:latest
        ports:
        - containerPort: 5678
          name: http
        volumeMounts:
        - name: aurora-secrets
          mountPath: "/mnt/secrets-store"
          readOnly: true
        env:
        # Load from ConfigMap
        - name: DB_TYPE
          valueFrom:
            configMapKeyRef:
              name: n8n-config
              key: DB_TYPE
        - name: DB_POSTGRESDB_HOST
          valueFrom:
            secretKeyRef:
              name: n8n-aurora-secrets
              key: DB_POSTGRESDB_HOST
        - name: DB_POSTGRESDB_PORT
          valueFrom:
            secretKeyRef:
              name: n8n-aurora-secrets
              key: DB_POSTGRESDB_PORT
        - name: DB_POSTGRESDB_DATABASE
          valueFrom:
            secretKeyRef:
              name: n8n-aurora-secrets
              key: DB_POSTGRESDB_DATABASE
        - name: DB_POSTGRESDB_USER
          valueFrom:
            secretKeyRef:
              name: n8n-aurora-secrets
              key: DB_POSTGRESDB_USER
        - name: QUEUE_BULL_REDIS_HOST
          valueFrom:
            configMapKeyRef:
              name: n8n-config
              key: QUEUE_BULL_REDIS_HOST
        - name: QUEUE_BULL_REDIS_PORT
          valueFrom:
            configMapKeyRef:
              name: n8n-config
              key: QUEUE_BULL_REDIS_PORT
        - name: EXECUTIONS_MODE
          valueFrom:
            configMapKeyRef:
              name: n8n-config
              key: EXECUTIONS_MODE
        - name: N8N_PORT
          valueFrom:
            configMapKeyRef:
              name: n8n-config
              key: N8N_PORT
        - name: N8N_PROTOCOL
          valueFrom:
            configMapKeyRef:
              name: n8n-config
              key: N8N_PROTOCOL
        - name: N8N_DEFAULT_BINARY_DATA_MODE
          valueFrom:
            configMapKeyRef:
              name: n8n-config
              key: N8N_DEFAULT_BINARY_DATA_MODE

        # Load from Secrets
        - name: DB_POSTGRESDB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: n8n-aurora-secrets
              key: DB_POSTGRESDB_PASSWORD
        - name: N8N_ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: n8n-secrets
              key: N8N_ENCRYPTION_KEY
        - name: N8N_BASIC_AUTH_USER
          valueFrom:
            secretKeyRef:
              name: n8n-secrets
              key: N8N_BASIC_AUTH_USER
              optional: true
        - name: N8N_BASIC_AUTH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: n8n-secrets
              key: N8N_BASIC_AUTH_PASSWORD
              optional: true

        # Main instance specific
        - name: N8N_BASIC_AUTH_ACTIVE
          value: "true"

        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 2Gi

        livenessProbe:
          httpGet:
            path: /healthz
            port: 5678
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5

        readinessProbe:
          httpGet:
            path: /healthz
            port: 5678
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5

      volumes:
      - name: aurora-secrets
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: n8n-aurora-secrets-provider
